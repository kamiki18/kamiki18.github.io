---
layout: default
title: test page
---

## fractional PLL の rational approximation

f<sub>test</sub> f^test^

\[tex:{\frac{分子}{分母}}\]

\\[
ax^2 + bx + c = 0 \\\
y = x^{1 + \quad \frac{1}{2}}
\\]


Si5351 の PLL 段出力 $ f_{\text{PLL1}}, f_{\text{PLL2}} $, それにクロック出力  $ f_{\text{CLK0}}, f_{\text{CLK1}}, f_{\text{CLK2}} $
は入力 $ f_{c} $ (NanoVNA の場合で 26MHz) を使って $ f_{\text{PLL}} = f_c (m_p + n_p/d_p) $, $ f_{\text{CLK}} = f_{\text{PLL}} /(m_m + n_m/d_m) / 2^r $
のように設定する。まあ各定数 $m_p, n_p, d_p, m_m, n_m, d_m, r $ には上限下限やらなんやら色々制限があるけれど、以下で興味があるのは
$ n_p, d_p, n_m, d_m $ についての$ 2^{20} $ 未満という制約だけ。 

さて。たとえば目標周波数 $ f_{\text{CLK1}} = 10000189 \text{[Hz]} $ の場合、$ f_{\text{CLK0}}, f_{\text{CLK1}}, f_{\text{CLK2}} $ それぞれについて現状、 

\\begin{eqnarray}
 f_{\text{PLL}}  &=& 26000000 \cdot 32 = 832000000,  \\\
 f_{\text{CLK0}} &=& 832000000 / (83 + 124019 / 625011) / 1  = 10000189.08 \text{[Hz]}  \\\
 f_{\text{CLK1}} &=& 832000000 / (83 + 98082 / 625324) / 1 =  10005189.00 \text{[Hz]}  \\\
 f_{\text{CLK2}} &=& 832000000 / (104 + 0 / 1) / 1 = 8000000 \text{[Hz]}
\\end{eqnarray}

という設定をしている。しかし Si5351 的にはもうすこし頑張ってみることができ、$ f_{CLK0} $ の場合で
\\begin{eqnarray}
 832000000 &/& (83 + 429 / 2162)    = 10000189.0201529,  \\\
 832000000 &/& (83 + 13149 / 66266) = 10000189.0000176,  \\\
 832000000 &/& (83 + 40507 / 204140) = 10000188.9999998    \\\
\\end{eqnarray}
のような設定が可能だ。
基本的に fractional PLL で分数の分母が max $ 2^M $ であるとき、ほぼ $ 2^{2M} $ 程度の分解能がある。Si5351 は $d_p, d_m$ に 20bit あるから分解能は 40bit,
1GHz (30bit) なら $ 1/2^{10} $ [Hz] 程度の分解能があるはずであり、実際、上の例はその程度はあることを示している。



fpll / (m + n/d) について。  m で割る周回のうち、d カウント中  n 回は m+1 で割るという意味である。n/d が小さいほど FM としてサイドバンドは小さく、狭い。
fpll * (m + n/d) について。  m 倍する周回のうち、d カウント中  n 回は m+1 倍する意味である。n/d が小さいほど FM としてサイドバンドは小さく、狭い。

124019/625011 だろうが 429/2162 だろうが FM的なノイズは大差ない。



### CLK2 を厳密に 8MHz にすること。

CLK2 は TLV320AIC3204 のマスタクロック、とついでに STM32F072 への MCLK に繋がっている。
つまり物理的には STM32F072 も CLK2 で動作させることを想定した回路になっているが、実際には STM32F072 は内部クロック HSI で動いており、MCLK は使っていない。閑話休題、
NanoVNA は TLV320AIC3204 のマスタクロックとして 8MHz を想定しており、CLK2 は PLL の状態如何にかかわらず 8MHz に固定しなければならない。


TLV320AIC3204 内部の PLL で 48ksps 用のクロックを 8MHz から作成している:

ADC_Fs = 48ksps, AOSR = 128 について

applicationg guide p37  によれば、
CODEC_CLKin = NADC * MADC * AOSR * ADC_Fs の関係にある。 MADC * AOSR / 32 \ge RC(リソースクラス; 消費電力を規定)
CODEC_CLKin = NDAC * MDAC * DOSR * DAC_Fs の関係にある。 MDAC * DOSR / 32 \ge RC

PLL は p73 から。CLKin < 20MHz. PLL out = 80..137MHz.

PLL clk = CLKin * (R * (J + D/10000)) / P  = 8000000 *  (1 * 10 + 7520/10000) / 1 =  86016000 Hz.


    /* 8.000MHz*10.7520 = 86.016MHz, 86.016MHz/(2*7*128) = 48kHz */
    I2CWrite(AIC3204_ADDR, 0x05, 0x91); /* Power up PLL, P=1,R=1 */
    I2CWrite(AIC3204_ADDR, 0x06, 0x0a); /* J=10 */
    I2CWrite(AIC3204_ADDR, 0x07, 29);    /* D=7520 = (29<<8) + 96 */
    I2CWrite(AIC3204_ADDR, 0x08, 96);

#ifdef REFCLK_12000KHZ
    /* 12.000MHz*7.1680 = 86.016MHz, 86.016MHz/(2*7*128) = 48kHz */
    I2CWrite(AIC3204_ADDR, 0x05, 0x91); /* Power up PLL, P=1,R=1 */
    I2CWrite(AIC3204_ADDR, 0x06, 0x07); /* J=7 */
    I2CWrite(AIC3204_ADDR, 0x07, 6);    /* D=1680 = (6<<8) + 144 */
    I2CWrite(AIC3204_ADDR, 0x08, 144);



8000000 * 10.7520 = 86.016 MHz を作成、そののち 86.016 MHz / (2*7*128) = 48kHz で 48sps とする。

14 で割る分周はともかく、1344/125 倍する PLL がとても気になる。

832000000  = 1625/12 * 48000 * 128 に注意して、

48ksps での動作のために 48000 * 128 = 6144000 Hz が必要で、x4 = 24576000 を理想的とする。 // PLL を使わない場合、MCLK は 50MHz まで。

つまり 832000000 * 12/1625 * 5 = 832000000 / (27 + 1/12) = 30.72MHz = 6144000 * 5.              // P = 5 でいいなら。
       832000000 * 12/1625 * 3 = 832000000 / (45 + 5/36) = 18.432MHz = 6144000 * 3.        // PLL clkin*P は 20MHz まで。
       832000000 * 1/104 =  8000000.
      gcd(26000000, 8000000) = 2000000
      gcd(26000000, 18432000) = 16000

pll clkin 13MHz として、gcd(13000000, 6144000) = 8000, 1625 -> 768 ie.  6144000 = 13000000 * 768/1625.

13000000 * 13*768/1625 = 13000000 * 768/125 = 13000000 * 6.1440 = 79872000 Hz を作成、 79872000 / (13*128) = 48000Hz. て PLL が下限突破。

6144000 * 14 = 86016000
          15 = 92160000
	  
(13000000, 61440000000) = (13, 614400) i.e.   6144000 = 13000000 * 614400/13 / 10000
 


26000000 * 32 = 832000000
832000000 / 104 = 8000000.
8000000 * 1344/125 =  86016000.     // 1344 = 2^6*3*7.   1625 = 5^3*13
86016000 / (14*128) = 48000.





26000000 * 32 = 832000000 だからこれは崩せない。
26000000 * 34 = 884000000 してももうからん。 

884000000 / 17 / 13 =  4000000




のだが、この PLL の動作速度が規定されてない ... ような気すんだが、どこに書いてあるんだろう。
8 * 128 / 26 

applicatoin guide の p77, p86 に 10ms の記載。




  $ f_{PLL} $ を 832MHz に固定する場合は問題ない。問題は $ f_{PLL} $ を動かす場合で、
\\[
   f_{PLL2} = 26000000 \cdot (m_p + n_p/d_p)  \\\
   f_{CLK2} = 8000000 = f_{PLL2} / (m_m * d_m + n_m)
\\]
から
\\[
   8000000 = 26000000 \cdot (m_p + n_p/d_p) / (m_m * d_m + n_m),
\\]

$ 26MHz \cdot ( m + n/d) / 8MHz = 26MHz * (m * d + n) / (d * 8MHz) = (13 * m * d + 13 * n) / (4 * d), $

\\[ 26MHz * ( m + n/d)] / [(13 * m * d + 13 * n) / (4 * d)] = 8MHz \\]

を得る。故に分母の 4 * d が 2^{20} を越えないなら、どのような m,n,d についても MCLK 用の Multisynth が解をもつ。
つまり、CLK1 用の PLL の分母が 2^{18} を越えないようにすればよい。
上に書いたように、2^{18} とれるなら 36bit 程度の分解能があり、1GHz 以下で問題なく 1Hz ステップがとれる。


10000  - 104000000
         83200000 / M
         83200000 / M
         83200000 -> 8MHz 固定

104MHz * 3 = 312MHz
104MHz * 5 = 520MHz
104MHz * 7 = 728MHz

だから、
                               freq              ofreq
         18000 - 500000        500kHz            500kHz        R = 64.   18kHz時、(18kHz,23kHz)の組。TLV直前のLPF(10kHz)での減衰を確認のこと。
                4000000        4MHz              4MHz          R = 8.  R=1 だと 832MHz/
              104000000以下    104MHz            104MHz          //  ここまで band0
	      150000000        PLL/6             PLL/6           //  ここまで band1
	      225000000        PLL/4             PLL/4
	      300000000        PLL/4             PLL/4          // 100MHz*3 でもよさげだが gain table の都合もある。
        freq/3,ofreq/5 の領域
	      312000000        104MHz*3          62.4MHz*5
	      450000000        PLL/6*3           90MHz*5
	      520000000        PLL/4*3           104MHz*5
              750000000        PLL/4*3           PLL/6*5        //  728MHz = 104*7 だが、gain table の都合上 x5 固定。
              900000000        PLL/4*3           PLL/4*5
        freq/5,ofreq/7 の領域
             1050000000以下    PLL/4*5           PLL/6*7
             1500000000以下    PLL/4*5           PLL/4*7

struct { int m, n, d } frac_val;
             frac_val setup_ofreq();   CLK2 をセットアップして実行、CLK1 について設定
             frac_val setup_freq();    CLK0 について設定、CLK0, CLK1 について実行。

周波数設定は標準で 3ms, band 変更に 10ms + ロック時間。
                        ゲイン変更に 10ms.
とやっておいて 3以下 8以上なら 3-8 に収めるとかなんなん。


0.4.1 のゲインテーブル
// {gainLeft, gainRight}
static const int8_t gain_table[][2] = {
    {  0,  0 },     // 1st: 0 ~ 300MHz
    { 43, 40 },     // 2nd: 300 ~ 600MHz      // つーかいきなり +20dB とかすごいな。
    { 53, 50 },     // 3rd: 600 ~ 900MHz
    { 75, 72 },     // 4th: 900 ~ 1200MHz     // eg. ref用が +37.5dB, input用が +36dB( -1.5dB されている)
    { 83, 80 },     // 5th: 1200 ~ 1400MHz
    { 93, 90 },     // 6th: 1400MHz ~         // +47.5dB とフル。
};
    uint8_t data[] = {
        2, 0x00, 0x01, /* Select Page 1 */
        2, 0x3b, lgain, /* Unmute Left MICPGA, set gain */      IN2(ref) 用チャネル。入力インピは 10kΩに設定。
        2, 0x3c, rgain, /* Unmute Right MICPGA, set gain */     IN3 と IN1 を切替えるチャネル。入力インピは 10kΩに設定。
        0 // sentinel
    };

si5351_set_frequency_with_offset(uint32_t freq, int offset, uint8_t drive_strength) とトラップ。

手で freq, ofreq, delay の設定変更。
main::sweep() での delay 設定変更。   なお si5351_set_frequency_with_offset()  内で pll lock している。
PLL2 = 832MHz, MCLK = 8MHz は固定。CLK0 を PLL, CLK1 を multisynth で。
IIR の変更。delay.   data.nanovna で max 27ms.  



  /**
   *                         freq              ofreq
   *   10000 - 500000        500kHz            500kHz         // R = 64.   832MHz/(1300 + 0/d)/64 = 10kHz. m=1800で 7.2kHz.
   *          4000000        4MHz              4MHz           // R = 8.  R=1 だと 832MHz/1800 = 4862kHz が下限。
   *        104000000以下    104MHz            104MHz         //  ここまで band0     832MHz/(8 + n/d).
   *        150000000        PLL/6             PLL/6          //  ここまで band1     PLLは 600〜900MHz。ちょうどぴったり。
   *        225000000        PLL/4             PLL/4          // PLLの定格範囲。     同じく。
   *        300000000        PLL/4             PLL/4          // 100MHz*3 でもよさげだが gain table の都合もある。PLLは 900〜1200MHz/(1200.02MHz)
   *  freq/3,ofreq/5 の領域
   *        312000000        104MHz*3          62.4MHz*5      //  832000000/(8 + 1/1048575)*3 = 311999962.81 で、これ以上で freq の残差大。
   *        450000000        PLL/6*3           90MHz*5        //  freq PLLは 624〜900.
   *        520000000        PLL/4*3           104MHz*5       //  freq は 600〜693.    832000000/(8 + 1/262143)*5 = 519999752.04 で、これ以上で ofreq の残差大。
   *        750000000        PLL/4*3           PLL/6*5 (*)    //  freq は 〜1000, ofreq は 624〜900.  728MHz = 104*7 だが、gain table の都合上 x5 固定。
   *        900000000        PLL/4*3           PLL/4*5        //  freq は 〜1200, ofreq は 600〜720.
   *  freq/5,ofreq/7 の領域
   *       1050000000以下    PLL/4*5           PLL/6*7 (*)    //  freq は 720〜840, ofreq は 771〜900.  ofreq は /4 で使えない (900/6*7=1050MHz).
   *       1500000000以下    PLL/4*5 (*)       PLL/4*7 (*)    //  freq は   〜1200, ofreq は 600〜857.
   * (*) は unsigned long long が必要になるケース。f * n > 2^32.
   *
   **/

multisynth の分解能

832000000 / 8  =                 104000000
832000000 / (8 + 1/(2^20 - 1) ) =103999987.602224
                                   残差 12.3977




freq が 3 倍で使う 300..312MHz や ofreq が 5 倍で使う 300..520MHz あたりがもっとも深刻。 
832000000 / 8 * 3 =                   312000000
832000000 / (8 + 1/(2^20 - 1) ) * 3 = 311999962.806671
で 37Hz,

832000000 / 8 * 5                   = 520000000
832000000 / (8 + 1/(2^20 - 1) ) * 5 = 519999938.011118
で残差 72Hz.
832000000 / (8 + 1/(2^18 - 1) ) * 5 = 519999752.043850
なら 248Hz.

freq の 300..312MHz は諦めるとしても ofreq の 520MHz直前をどうするか。
PLL可変域に組み込んだとしても PLL = 600MHz の時に 600/6 * 5 = 500 なので 300〜500MHz が問題となる。

520000000/5 * 8.5 = 884000000 で、26000000 * 34 = 884000000 だから整数化OK.

884000000 / (8 + (2^19 + 0)/(2^20 - 1) ) * 5 =  519999970.828759
884000000 / (8 + (2^19 - 1)/(2^20 - 3) ) * 5 =  519999970.828704 で 0.00005Hz化。


                                                         24 = 624MHz                    75.18    72.55
							   ...
							      884MHz    /9.3 〜 /9.6 =  95.05 〜 92.08
							 30   780       /8.3     8.6    93.97    90.70
							 31   806                       97.10    93.72
freq = 100.000000MHz  ->  x8.5 = PLL 850MHz  //  26MHz * 32 = 832MHz.   /8.3 〜 /8.6 = 100.24 〜 96.74
                                                 26MHz * 33 = 858MHz.   /8.3 〜 /8.6 = 103.37 〜 99.76
                                                         34   884                      106.50   102.79      upto 106MHz.
                                                         35   910                      109.63   105.81
							   ...
                                                         46  1196 
                                                         47  1222MHz.


目標 f [Hz] について 832MHz / f = m + n/d, 
                     (832MHz + delta) / f = m + n/d + 1/2 とおくと、
		     delta =  f * 1/2, delta = N * 26 とみて N = f / 52.




残差 1Hz 以下とすると、

832000000 / n - 832000000 / (n + 1/M)  = ((n + 1/M) * 832000000 + 832000000 * n)/ (n * (n + 1/M))
                                       =  1/M * 832000000 / (n * (n + 1/M)) 
                                       =  832000000 / (n * (n*M + 1))
				       = 1 として、 

  M*n^2 + n - 832000000 = 0
を得る。
M = 1048575 を代入して 1048575*n^2 + n - 832000000 = 0,  n = 28... を得る。

832000000 / 28  =                  29714285.7142857             29.7MHz をボーターに?
832000000 / (28 + 1/(2^20 - 1) ) = 29714284.7022222

M = 262143 を代入して n = 6834 ... 1800 越えられねん。





PLL サイド。

26000000 * 24/4                = 156000000                             // 26000000 * 23 = 598MHz で PLL 範囲外。
26000000 * (24 + 1/1048575)/4  = 156000006.19889 で 6Hz ステップ。

26000000 * 34/6                = 147333333.333333                      // 26000000 * 35 = 910MHz で PLL 範囲外。
26000000 * (34+ 1/1048575)/6   = 147333337.465926   4Hz.

26000000 * 46/6                = 199333333.333333                     // 26000000 * 47 = 1222MHz で PLL 範囲外。
26000000 * (46+ 1/1048575)/6   = 199333337.465926   4Hz.

7倍高調波は
26000000 * (32 + 0/1048575)/4 * 7  =  1456000000
26000000 * (32 + 1/1048575)/4 * 7  =  1456000043.39222 で 43Hz ステップ。
26000000 * (34 + 0/1048575)/6 * 7  =  1031333362.26148
26000000 * (34 + 1/1048575)/6 * 7  =  1031333333.33333 で 29Hz ステップ。

26000000 * (28 + 0/1048575)/4 * 5  =  910000000
26000000 * (28 + 1/1048575)/4 * 5  =  910000030.994445 で  31Hzステップ。


