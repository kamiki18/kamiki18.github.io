---
layout: default
title: Voltage drop of VBAT Diode.
auther: kamiki18
revision: Nov. 25, 2019.
---

## VBATダイオードの電圧降下

STM32F0x2 のリファレンスマニュアル (p80) には

 > スタートアップの時、 VDD > VBAT + 0.6[V] の間は VDD から内部ダイオードを経由して VBATピンへ電流が流れる。
 > もし VBAT にバッテリなどが繋がるなら、逆流阻止のため VBAT へダイオードをいれるべし。

なる記述がある。これにより NanoVNA の回路にはダイオード D1 が入っている (NanoVNA-a1-20170115.pdf の p9)。
NanoVNA-H の回路だと D2 になる (User Guide_20190711 の p12)。

さて。バッテリの電圧を測る目的で、STM32F072 の ADC の入力として ADC を選ぶことができる。
しかしそうすると D1 の電圧降下分を考慮しなくてはならない。
これは如何ほどだろうか。評価のためには電流を見積もらなければならないが、まず、

 - VDD > VBAT であるかぎり VBAT から STM32 が消費するための電流がながれこむことはない。
   ついでに言えば、流れこむ状態になった時も 1〜2μA である (データシートの p60 より)。
   念のためだが、バッテリ動作している時も STM32 は VDD からエネルギーの供給を受けているのであって、VBAT はほぼ無関係である。

あれ、よく見ると電源をオフにするというのはバッテリバックアップの状態にすることなのね。MCU の RTC ドメインは活きてる。
閑話休題、

 - BAT から ADC への入力は 50kΩのブリッジである (STM32F072xBの データシートの p92 より)。
   4V 近くになるバッテリ電圧を 3V 台の VDD の ADC で直接測ることはできないから、測るために 1/2 にしている。よって入力インピーダンスは約 100kΩ、たぶん。

ADC が活きている時はバッテリバックアップではなく、正常動作している。つまり  RTCドメインへの流れ込みはなく、ブリッジへの電流のみである。
つまりフル充電で 4V 前後のバッテリでは、VBAT へ 40μA ほどが流れ込んでいる。

NanoVNAでは D1 に BAT54C が指定されている。該当のデータシートをみると、既にグラフの枠外なのだが、それっぽく延長して 25 度でたぶん約 150mV あたり。
NanoVNA-H の D2 は SD103AWS が指定されていて、... やはりグラフの枠外なのでがんばって延長して同じく 150mV あたり。
きちんとグラフから読めるものを探すと、秋月にある RB751S (30mA 級ショットキー) で実際に 150mV あたり。
もちろん実装されているダイオードによって数値は異なるが、回路図で指定されているダイオードがデフォルト設定であるべきだろう。


### 実測

で、本題。黒ABSケース入りNanoVNA-H の(おそらく)初版モノで 40mV (P-16 にて) 〜 70mV (CDA-701 にて) であった。

ダイオード両端での電圧を直接測ると理論値で 150mV/0.16mA = 940Ω という、そこそこインピーダンスの高い部分の電圧を測ることになるし、
GND との電位差を測って引き算するのも精度が落ちる。
テスタの測定精度限界に近いあたりで数値の確度とかそういうものはないが、まあ 100mV 弱ということだろう。


### 初期値

実は NanoVNA-H のファームウエアでは電圧降下の配慮はない。しかしそれ以外では、

~~~ c

#define VBAT_DIODE_VF 500

~~~

だったり

~~~ c

config_t config = {
  .vbat_offset =     500,
};

~~~

だったりと文面は色々だが 500mV は過大じゃないかな。というか誰も実測してないという疑惑がちょっとある。


### もののとっかかり

NanoVNA-Q のファームウエアだと info 画面で VBAT の電圧を数値で報告してくれる。そこで 4.7V と出るとかどうみてもおかしかった。

### References  {#ref}

 * NanoVNA-a1-20170115.pdf ([NanoVNAキット](https://ttrf.tk/kit/nanovna/) より)
 * RM0091 Reference manual STM32F0x1/STM32F0x2/STM32F0x8 (DocID018940 Rev 9)
 * NanoVNA User Guide_20190711.pdf  ([Nano-VNA-H](https://github.com/hugen79/NanoVNA-H) の doc内 )
 * STM32F072x8,STM32F072xB (DS9826 rev 6)
 * SD103AWS datasheet   <!-- https://www.diodes.com/assets/Datasheets/ds30101.pdf -->
 * [NanoVNA-Q](https://github.com/qrp73/NanoVNA-Q)
